@{
    ViewData["Title"] = "Hotel";
}

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark gradient-custom">
    <!-- Container wrapper -->
    <div class="container-fluid">
        <!-- Navbar brand -->
        <a class="navbar-brand" href="#">FunNow</a>

        <!-- Toggle button -->
        <button class="navbar-toggler" type="button" data-mdb-toggle="collapse"
                data-mdb-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <i class="fas fa-bars text-light"></i>
        </button>

        <!-- Collapsible wrapper -->
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <!-- Left links -->
            <ul class="navbar-nav me-auto d-flex flex-row mt-3 mt-lg-0">
                <li class="nav-item text-center mx-2 mx-lg-1">
                    <a class="nav-link" href="#!">
                        <div>
                            <i class="fa-solid fa-user mb-1"></i>
                            <span class="badge rounded-pill badge-notification bg-dark"></span>
                        </div>
                        會員
                    </a>
                </li>
                <li class="nav-item text-center mx-2 mx-lg-1">
                    <a class="nav-link" href="#!">
                        <div>
                            <i class="fa-solid fa-house mb-1"></i>
                            <span class="badge rounded-pill badge-notification bg-dark">2</span>
                        </div>
                        房東
                    </a>
                </li>
                <li class="nav-item text-center mx-2 mx-lg-1">
                    <a class="nav-link" href="#!">
                        <div>
                            <i class="fa-solid fa-face-smile mb-1"></i>
                            <span class="badge rounded-pill badge-notification bg-dark">11</span>
                        </div>
                        評論
                    </a>
                </li>
                <li class="nav-item text-center mx-2 mx-lg-1">
                    <a class="nav-link" href="#!">
                        <div>
                            <i class="fa-solid fa-comment mb-1"></i>
                            <span class="badge rounded-pill badge-notification bg-dark">1</span>
                        </div>
                        訊息
                    </a>
                </li>
                <li class="nav-item text-center mx-2 mx-lg-1">
                    <a class="nav-link" href="#!">
                        <div>
                            <i class="fa-solid fa-chart-line mb-1"></i>
                            <span class="badge rounded-pill badge-notification bg-dark"></span>
                        </div>
                        數據分析
                    </a>
                </li>
            </ul>
            <!-- Left links -->
        </div>
        <!-- Collapsible wrapper -->
    </div>
    <!-- Container wrapper -->
</nav>
<!-- Navbar -->
<div class="container">
    <h3 class="m-3">飯店審核管理</h3>
</div>

<div class="container mt-3 d-flex flex-row">
    <div class="input-group width px-3">
        <select class="form-select" id="inputGroupSelecthotel" aria-label="Example select with button addon">
            <option selected>所有飯店類型</option>
            <!-- 動態添加的酒店名稱將在這裡顯示 -->
        </select>
    </div>

    <div class="input-group width px-1">
        <!--px-1(數字好像可以填1到9越小越寬) -->
        <select class="form-select" id="inputGroupSelectstatus" aria-label="Example select with button addon">
            <option selected>所有審核狀態</option>
            <option value="true">已上架</option>
            <option value="false">待審核</option>
        </select>
    </div>

    <div class="ms-5">
        <span>
            <input type="text" class="form-control display" id="searchBar" aria-label="" placeholder="輸入文字">
        </span>
    </div>
    <div>
        <input type="button" class="btn btn-outline-primary display" id="searchBtn" value="搜尋" onclick="searchHotels()">
    </div>
    <div class="ms-2">
        <input type="button" class="btn btn-outline-secondary display" id="clearBtn" value="清除" onclick="clearFilters()">
    </div>
</div>

<div>
    <table class="container table table-hover hotelList">
        <thead>
            <tr>
                <td>編號</td>
                <td>飯店名稱</td>
                <td>飯店類型</td>
                <td>地址</td>
                <td>電話</td>
                <td>飯店狀態</td>
            </tr>
        </thead>
        <tbody id="hotelContainer">
            <!-- 飯店資料將在這裡顯示 -->
        </tbody>
    </table>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <style>
            /* 修改 modal-dialog 的 max-width 以增加寬度 */
            #exampleModal .modal-dialog {
                max-width: 80%; /* 例如將寬度設置為 80%，可以根據需要調整 */
            }
        </style>
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">飯店房間內容</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <td>房間編號</td>
                                <td>房型</td>
                                <td>房間價格</td>
                                <td>房間大小</td>
                                <td>房間描述</td>
                                <td>操作</td>
                            </tr>
                        </thead>
                        <tbody id="roomContainer">
                            <!-- 房間資料將在這裡顯示 -->
                        </tbody>
                    </table>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">返回</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        /*navbar*/
        .btn {
            padding: .45rem 1.5rem .35rem;
        }

        .gradient-custom {
            /* fallback for old browsers*/
            background: #004B97;
        }
        /*navbar*/

        .container {
            width: 70%;
        }

        .filterborder {
            border: 1px solid #0072E3;
            border-radius: 20px;
            margin-right: 20px;
        }

        .width {
            width: 15%;
        }

        .hotelList .btn {
            font-size: 14px;
        }
    </style>
}

@section Scripts {
    <script>
        let allHotels = [];

        // 獲取飯店資訊並更新顯示
        function fetchHotels() {
            fetch('https://localhost:7103/api/BackSideHotel/details')
                .then(response => response.json())
                .then(data => {
                    allHotels = data;
                    updateHotelDisplay(data);
                    updateSelectOptions();
                })
                .catch(error => {
                    console.error('Error fetching hotels:', error);
                });
        }

        // 更新飯店顯示
        function updateHotelDisplay(hotelList) {
            let tableStr = "";
            hotelList.forEach(item => {
                let status = item.hotelIsActive ? "已上架" : "待審核";
                let actionButton = item.hotelIsActive
                    ? `<td><button class="btn btn-danger" onclick="toggleHotelStatus(${item.hotelID})">下架飯店</button></td>`
                    : `<td><button class="btn btn-primary" onclick="toggleHotelStatus(${item.hotelID})">上架飯店</button></td>`;

                tableStr += `
                                    <tr data-hotel-id="${item.hotelID}">
                                        <td>${item.hotelID}</td>
                                        <td>${item.hotelName}</td>
                                        <td>${item.hotelTypeName}</td>
                                        <td>${item.hotelAddress}</td>
                                        <td>${item.hotelPhone}</td>
                                        <td>${status}</td>
                                        <td><button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="loadRooms(${item.hotelID})">詳細內容</button></td>
                                        ${actionButton}
                                    </tr>
                                `;
            });

            document.getElementById('hotelContainer').innerHTML = tableStr;
        }

        // 切换飯店的isActive狀態
        function toggleHotelStatus(hotelID) {
            fetch(`https://localhost:7103/api/BackSideHotel/${hotelID}/toggleActive`, {
                method: 'PUT'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    // 更新當前飯店的狀態
                    const hotel = allHotels.find(h => h.hotelID === hotelID);
                    hotel.hotelIsActive = !hotel.hotelIsActive;
                    // 保留篩選條件並更新顯示
                    applyFilters();
                })
                .catch(error => {
                    console.error('Error toggling hotel status:', error);
                });
        }

        // 獲取並顯示房間資訊
        function loadRooms(hotelID) {
            fetch(`https://localhost:7103/api/BackSideHotel/${hotelID}/rooms`)
                .then(response => response.json())
                .then(data => {
                    updateRoomDisplay(data);
                })
                .catch(error => {
                    console.error('Error fetching rooms:', error);
                });
        }

        // 更新房間顯示
        function updateRoomDisplay(roomList) {
            let roomTableStr = "";
            roomList.forEach(item => {
                let roomStatus = item.roomStatus ? "可預訂" : "已滿";
                let actionButton = item.roomStatus
                    ? '<td><button class="btn btn-danger" onclick="deactivateRoom()">下架房間</button></td>'
                    : '<td><button class="btn btn-primary" onclick="activateRoom()">上架房間</button></td>';

                roomTableStr += `
                                    <tr>
                                        <td>${item.roomID}</td>
                                        <td>${item.roomType}</td>
                                        <td>${item.roomPrice}</td>
                                        <td>${item.roomSize} 平方公尺</td>
                                        <td>${item.description}</td>
                                        ${actionButton}
                                    </tr>
                                `;
            });

            document.getElementById('roomContainer').innerHTML = roomTableStr;
        }

        // 清除篩選和搜尋
        function clearFilters() {
            document.getElementById('inputGroupSelecthotel').value = "所有飯店類型";
            document.getElementById('inputGroupSelectstatus').value = "所有審核狀態";
            document.getElementById('searchBar').value = "";
            updateHotelDisplay(allHotels);
        }

        // 初始加載飯店資訊
        fetchHotels();

        function updateSelectOptions() {
            let selecthoteltypeStr = "<option selected>所有飯店類型</option>";
            let hotelTypeSet = new Set();  // 使用Set來記錄已經添加過的飯店類型

            allHotels.forEach(item => {
                // 只有當該飯店類型尚未添加到Set中時，才添加到select元素中
                if (!hotelTypeSet.has(item.hotelTypeName)) {
                    selecthoteltypeStr += `<option value="${item.hotelTypeName}">${item.hotelTypeName}</option>`;
                    hotelTypeSet.add(item.hotelTypeName);   // 記錄已添加的飯店類型
                }
            });

            document.getElementById('inputGroupSelecthotel').innerHTML = selecthoteltypeStr;
        }

        function fetchRoomsByHotelId(hotelID) {
            console.log(`Fetching rooms for hotelID: ${hotelID}`);
            // 確保 hotelID 為數字類型
            const numericHotelID = Number(hotelID);
            const hotel = allHotels.find(hotel => hotel.HotelID === numericHotelID);
            if (hotel) {
                console.log(`Rooms data for hotelID ${numericHotelID}:`, hotel.Rooms);
                updateRoomDisplay(hotel.Rooms);
            } else {
                console.error(`Hotel with ID ${numericHotelID} not found.`);
            }
        }

        function applyFilters() {
            let selectedHotelTypeName = document.getElementById('inputGroupSelecthotel').value;
            let selectedHotelStatus = document.getElementById('inputGroupSelectstatus').value;
            filterHotels(selectedHotelTypeName, selectedHotelStatus);
        }

        function filterHotels(hotelTypeName, hotelStatus) {
            let filteredHotels = allHotels.filter(item => {
                let matchesType = hotelTypeName === "所有飯店類型" || item.hotelTypeName === hotelTypeName;
                let matchesStatus = hotelStatus === "所有審核狀態" || item.hotelIsActive.toString() === hotelStatus;
                return matchesType && matchesStatus;
            });
            updateHotelDisplay(filteredHotels);
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchHotels();

            document.getElementById('inputGroupSelecthotel').addEventListener('change', () => {
                applyFilters();
            });

            document.getElementById('inputGroupSelectstatus').addEventListener('change', () => {
                applyFilters();
            });

            document.getElementById('searchBtn').addEventListener('click', () => {
                searchHotels();
            });

            document.getElementById('clearBtn').addEventListener('click', () => {
                clearFilters();
            });

            document.getElementById('searchBar').addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    searchHotels();
                }
            });
        });
    </script>
}



