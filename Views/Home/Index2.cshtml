@{
    ViewData["Title"] = "Home Page2";
    Layout = "_Layout_index2";
}

<br />
<!--================ 台灣熱門城市 Area  =================-->
<section class="accomodation_area section_gap">

    <br /><br /><br /><br />


    <div class="container">
        <div class="row mb_30">
            <div class="col-lg-3 col-sm-6" ">
            @* //畫面靠左 3/12 位置 *@
                <div class=">
                    <a class="book_now_btn button_hover" href="#">
                        <img src="~/image/ming_img/map.png" alt="">
                    </a>
                </div>

                <div>
                    <a class="book_now_btn button_hover" href="#" style="border-radius: 20px;background: #F0F0F0; text-align:left">
                        <img src="~/image/ming_img/search.png" alt="">搜尋關鍵字
                    </a>
                </div>
                <br />
                <p style="margin:0px 10px">每晚預算</p>

                <!--//價格搜尋拉霸start-->
                <div class="slider-container" style="margin: 10px">
                    <div class="range-slider" id="rangeSlider" min="1" max="10000">
                        <div class="slider-handle lower-handle" id="lowerHandle"></div>
                        <div class="slider-handle upper-handle" id="upperHandle"></div>
                    </div>
                    <div class="label-container">
                        <span id="lowerLabel">下限：1</span>
                        <span id="upperLabel">上限：10000</span>
                    </div>
                    <div class="input-container">
                        <input type="number" id="lowerInput" value="1" style="margin-right: 10px;" class="no-spinner">
                        <input type="number" id="upperInput" value="10000" class="no-spinner">
                    </div>
                </div>
                <!--//價格搜尋拉霸end-->
                <br />
                <br />

                <div style="margin:20px 10px" class="form-check-container-hotel-type">
                    <p>住宿類型</p>
                @foreach (var hotelType in Model.HotelTypes)
                {
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="@hotelType.HotelTypeId" id="hotelType_@hotelType.HotelTypeId">
                            <label class="form-check-label" for="hotelType_@hotelType.HotelTypeId">
                            @hotelType.HotelTypeName
                            </label>
                        </div>
                }
                </div>

                <div style="margin:20px 10px" class="form-check-container-hotel-equipment">
                    <p>住宿設備</p>
                @foreach (var hotelEquipment in Model.HotelEquipments)
                {
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="@hotelEquipment.HotelEquipmentId" id="hotelEquipment_@hotelEquipment.HotelEquipmentId">
                            <label class="form-check-label" for="hotelEquipment_@hotelEquipment.HotelEquipmentId">
                            @hotelEquipment.HotelEquipmentName
                            </label>
                        </div>
                }
                </div>

                <div style="margin:20px 10px" class="form-check-container-city">
                    <p>城市</p>
                    <div class="form-check-container">
                    @foreach (var city in Model.Cities)
                    {
                            <div class="form-check city-item">
                                <input class="form-check-input" type="checkbox" value="@city.CityId" id="city_@city.CityId">
                                <label class="form-check-label" for="city_@city.CityId">
                                @city.CityName
                                </label>
                            </div>
                    }
                    </div>
                    <button id="toggleCityButton" class="toggle-button">顯示更多</button>
                </div>

                <div style="margin:20px 10px" class="form-check-container-room-equipment">
                    <p>房間設備</p>
                @foreach (var roomEquipment in Model.RoomEquipments)
                {
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="@roomEquipment.RoomEquipmentId" id="roomEquipment_@roomEquipment.RoomEquipmentId">
                            <label class="form-check-label" for="roomEquipment_@roomEquipment.RoomEquipmentId">
                            @roomEquipment.RoomEquipmentName
                            </label>
                        </div>
                }
                </div>
            </div>


            <div class="col-lg-9 col-sm-12">
            <div class="navbar">
                <button id="sortBtn">排序</button>
                <button id="bestMatchBtn">最匹配選項</button>
                <button id="highestRatedBtn">住客評鑑最高</button>
                <button id="lowestPriceBtn">最低價格優先</button>
                <button id="nearbyBtn">鄰近交通&景點</button>
                <button id="hotDealBtn" class="special-button">搶手特惠!</button>
            </div>
            @* //畫面靠右 9/12 位置 *@
                <div class="container">
                    <div class="row">
                        <div class="col-lg-12" style="border:1px solid gray">
                            <div class="container">
                                <div class="row" id="showhotels">
                                @* //動態生成旅館 *@
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!--================ 台灣熱門城市 Area  =================-->
@section Scripts {

    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            // 網頁加載完成後自動加載儲存在 sessionStorage 的 searchHotel 資訊
            // 一開始網頁加載來自index.cshtml
            const searchHotelJson = sessionStorage.getItem("searchHotel");
            if (searchHotelJson) {
                const searchHotel = JSON.parse(searchHotelJson);
                console.log(searchHotel);
                await loadHotels(searchHotel);
            } else {
                console.log("searchHotel not found in sessionStorage");
            }
        });

        // 監聽提交按鈕，獲取輸入值並發送請求
        // 此處網頁加載來自index2.cshtml
        const btnSubmit3 = document.querySelector("#buttonSubmit3");
        btnSubmit3.addEventListener("click", async () => {
            const searchHotel = {
                keyword: document.querySelector("#search-input3").value,
                checkInDate: document.querySelector("#myDatepickerstart3").value,
                checkOutDate: document.querySelector("#myDatepickerend3").value,
                roomnum: parseInt(document.querySelector("#rooms3").value),
                adults: parseInt(document.querySelector("#adults3").value),
                children: 0,
                sortBy: null,
                sortType: null,
                lowerPrice: parseInt(document.querySelector("#lowerInput").value),
                upperPrice: parseInt(document.querySelector("#upperInput").value),
            };

            // 儲存搜尋條件至 sessionStorage
            sessionStorage.setItem("searchHotel", JSON.stringify(searchHotel));
            // 發送請求並更新顯示結果
            await loadHotels(searchHotel);
        });

        // 定義排序按鈕及其對應的排序條件
        const sortButtons = {
            sortBtn: ["HotelId", "asc"],
            bestMatchBtn: ["LevelStar", "desc"],
            highestRatedBtn: ["LevelStar", "desc"],
            lowestPriceBtn: ["HotelPrice", "asc"],
            nearbyBtn: ["CityName", "asc"],
            hotDealBtn: ["deal", "desc"],
        };

        // 綁定排序按鈕的點擊事件
        Object.keys(sortButtons).forEach(id => {
            document.querySelector(`#${id}`).addEventListener("click", () => handleSort(...sortButtons[id]));
        });

        // 處理排序的邏輯函數
        async function handleSort(sortBy, sortType) {
            const searchHotelJson = sessionStorage.getItem('searchHotel');
            if (searchHotelJson) {
                const searchHotel = JSON.parse(searchHotelJson);
                searchHotel.sortBy = sortBy;
                searchHotel.sortType = sortType;
                sessionStorage.setItem('searchHotel', JSON.stringify(searchHotel));
                await loadHotels(searchHotel);
            } else {
                console.log('searchHotel not found in sessionStorage');
            }
        }

        // 定義範圍滑桿相關元素
        const rangeSlider = {
            lowerHandle: document.getElementById('lowerHandle'),
            upperHandle: document.getElementById('upperHandle'),
            slider: document.getElementById('rangeSlider'),
            lowerLabel: document.getElementById('lowerLabel'),
            upperLabel: document.getElementById('upperLabel'),
            lowerInput: document.getElementById('lowerInput'),
            upperInput: document.getElementById('upperInput')
        };

        // 設定 upperHandle 初始位置在滑動條的尾端
        const max = parseFloat(rangeSlider.slider.getAttribute('max'));
        const position = 100; // 百分比位置
        rangeSlider.upperHandle.style.left = `${position}%`;
        rangeSlider.upperLabel.textContent = `上限：${max}`;
        rangeSlider.upperInput.value = max;

        // 初始化 lowerHandle 和 lowerLabel
        rangeSlider.lowerHandle.style.left = '0%';
        rangeSlider.lowerLabel.textContent = '下限：1';
        rangeSlider.lowerInput.value = 1;

        // 綁定滑桿拖動事件
        [rangeSlider.lowerHandle, rangeSlider.upperHandle].forEach(handle => {
            handle.addEventListener('mousedown', startDrag);
        });

        let isDragging = false;
        let currentHandle = null;

        // 開始拖動的處理函數
        function startDrag(event) {
            isDragging = true;
            currentHandle = event.target;
            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('mouseup', stopDrag);
        }

        // 處理拖動邏輯的函數
        function handleDrag(event) {
            if (!isDragging) return;

            const handleType = currentHandle === rangeSlider.lowerHandle ? 'lower' : 'upper';
            const { handle, label, oppositeLabel, lowerInput, upperInput } = handleType === 'lower' ?
                { handle: rangeSlider.lowerHandle, label: rangeSlider.lowerLabel, oppositeLabel: rangeSlider.upperLabel, lowerInput: rangeSlider.lowerInput, upperInput: rangeSlider.upperInput } :
                { handle: rangeSlider.upperHandle, label: rangeSlider.upperLabel, oppositeLabel: rangeSlider.lowerLabel, lowerInput: rangeSlider.lowerInput, upperInput: rangeSlider.upperInput };

            const sliderRect = rangeSlider.slider.getBoundingClientRect();
            const position = Math.min(1, Math.max(0, (event.clientX - sliderRect.left) / sliderRect.width));
            const value = Math.round(parseFloat(rangeSlider.slider.getAttribute('min')) + position * (parseFloat(rangeSlider.slider.getAttribute('max')) - parseFloat(rangeSlider.slider.getAttribute('min'))));

            // 防止下限超過上限或上限低於下限
            if (handleType === 'lower' && value >= parseFloat(oppositeLabel.textContent.split('：')[1])) return;
            if (handleType === 'upper' && value <= parseFloat(oppositeLabel.textContent.split('：')[1])) return;

            handle.style.left = `${position * 100}%`;
            label.textContent = `${handleType === 'lower' ? '下限' : '上限'}：${value}`;
            handleType === 'lower' ? lowerInput.value = value : upperInput.value = value;
            updateHotels(parseFloat(rangeSlider.lowerInput.value), parseFloat(rangeSlider.upperInput.value));
        }

        // 停止拖動的處理函數
        function stopDrag() {
            isDragging = false;
            currentHandle = null;
            document.removeEventListener('mousemove', handleDrag);
            document.removeEventListener('mouseup', stopDrag);
        }

        // 更新飯店列表的函數
        async function updateHotels(lowerPrice, upperPrice) {
            const searchHotelJson = sessionStorage.getItem('searchHotel');
            if (searchHotelJson) {
                const searchHotel = JSON.parse(searchHotelJson);
                searchHotel.lowerPrice = lowerPrice;
                searchHotel.upperPrice = upperPrice;
                sessionStorage.setItem('searchHotel', JSON.stringify(searchHotel));
                await loadHotels(searchHotel);
            } else {
                console.log('searchHotel not found in sessionStorage');
            }
        }

        // 加載飯店的函數
        const loadHotels = async function (searchHotel) {
            const url = "https://localhost:7103/api/HotelSearch/indexsearch";
            const response = await fetch(url, {
                method: "POST",
                body: JSON.stringify(searchHotel),
                headers: { "Content-Type": "application/json" },
            });
            const data = await response.json();
            console.log(data);

            const divHotels = document.querySelector("#showhotels");
            divHotels.innerHTML = "";

            // 生成並顯示飯店信息
            const hotels = data.map(hotel => {
                const { hotelName, hotelAddress, hotelImage, levelStar, hotelEquipmentName, hotelPrice } = hotel;
                return `
                    <div class="col-lg-12 hotel-card">
                        <div class="row">
                            <div class="col-lg-4 col-sm-8" style="padding:0px">
                                <table>
                                    <tr>
                                        <td colspan="3"><img src='https://localhost:7284/image/${hotelImage}' class="img-fluid" style="width:100%" /></td>
                                    </tr>
                                    <tr>
                                        <td><img src="/image/ming_img/room1.jpg" class="img-fluid" /></td>
                                        <td><img src="/image/ming_img/room3.jpg" class="img-fluid" /></td>
                                        <td><img src="/image/ming_img/room4.jpg" class="img-fluid" /></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-lg-5 col-sm-10 hotel-details">
                                <h3>${hotelName}</h3>
                                <span>${levelStar}星級飯店 </span><span style="color:blue">${hotelAddress}</span>
                                <h6>此住宿提供:</h6>
                                <h5 style="border: 1px solid black;display: inline-block;">${hotelEquipmentName}</h5>
                                <br>
                                <h5 style="border: 1px solid black;display: inline-block;">設施2</h5>
                                <br>
                                <h5 style="border: 1px solid black;display: inline-block;">設施3</h5>
                                <br>
                                <h6 style="color:green">${levelStar}星級飯店最優價</h6>
                                <h6 style="color:red">昨天起已收到${levelStar}張訂單</h6>
                            </div>
                            <div class="col-lg-3 col-sm-12 hotel-pricing">
                                <h5>很出色</h5>
                                <h6 style="color:gray"> 個評分</h6>
                                <br>
                                <h6 style="border: 1px solid red;display:inline-block;background-color: red;color:white">優惠只剩1間</h6>
                                <h6 style="color:gray">每晚價格(不連税及其他费用)</h6>
                                <br><br>
                                <h3>NT$${hotelPrice}</h3>
                            </div>
                        </div>
                    </div>
                `;
            });

            divHotels.innerHTML = hotels.join("");

        };

    </script>

    <script>
        //解決checkbox內容太長的問題
        document.addEventListener("DOMContentLoaded", function () {
            const toggleButton = document.querySelector("#toggleCityButton");
            const formCheckContainer = document.querySelector(".form-check-container");

            toggleButton.addEventListener("click", function () {
                formCheckContainer.classList.toggle("expanded");
                if (formCheckContainer.classList.contains("expanded")) {
                    toggleButton.textContent = "顯示較少";
                } else {
                    toggleButton.textContent = "顯示更多";
                }
            });
        });
    </script>

}

@section Styles {
    <style>
         /* //價格搜尋拉霸設定 */
        .slider-container {
            display: flex;
            flex-direction: column;
        }

        .range-slider {
            position: absolute;
            width: 83%;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
        }

        .slider-handle {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #007bff;
            border-radius: 50%;
            cursor: pointer;
            top: -7px;
            z-index: 10;
        }

        .label-container {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .input-container {
            display: flex;
            justify-content: space-between;
        }

            .input-container input {
                width: 45%;
                z-index: 1;
            }

    </style>
    <style>
         /* //主搜尋欄的下拉式選單 */
        .navbar {
            display: flex;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

            .navbar button {
                margin: 0 5px;
                padding: 10px 15px;
                border: 1px solid #ccc;
                background-color: #fff;
                cursor: pointer;
            }

                .navbar button:hover {
                    background-color: #f1f1f1;
                }

            .navbar .special-button {
                background-color: #4285f4;
                color: white;
                border: none;
            }

                .navbar .special-button:hover {
                    background-color: #357ae8;
                }
        /* 移除 input 上下箭頭 */
        .no-spinner::-webkit-outer-spin-button,
        .no-spinner::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

    </style>
    <style>
        /* checkbox設定 */
        .form-check-container .city-item {
            display: none;
        }

            .form-check-container .city-item:nth-child(-n+10) {
                display: block;
            }

        .form-check-container.expanded .city-item {
            display: block;
        }

        .toggle-button {
            margin-top: 10px;
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
    </style>
    <style>
        /* 點擊旅館的效果 */
        .col-lg-4.col-sm-8 {
            height: 280px; /* 設置一個固定的高度，可根據需要調整 */
            padding: 0;
        }

            .col-lg-4.col-sm-8 table {
                height: 100%;
                width: 100%;
            }

            .col-lg-4.col-sm-8 img {
                object-fit: cover; /* 讓圖片完整顯示，並填滿容器 */
                height: 100%;
                width: 100%;
            }

        .hotel-card {
            margin: 10px 0; /* 添加間距 */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 5px;
            overflow: hidden;
            background-color: #fff; /* 設置初始背景為白色 */
            transition: box-shadow 0.3s ease, background-color 0.3s ease; /* 添加過渡效果 */
            display: flex; /* 使用 flex 布局 */
        }

            .hotel-card:hover {
                box-shadow: 0 8px 16px rgba(0,0,0,0.2); /* 滑鼠滑過時增加陰影 */
            }

                .hotel-card:hover .hotel-details, .hotel-card:hover .hotel-pricing {
                    background-color: #f0f8ff; /* 滑鼠滑過時變為淺藍色 */
                }

            .hotel-card h3 {
                margin-top: 10px;
            }

        .hotel-details {
            border: 1px solid gray;
            background-color: #fff; /* 初始背景為白色 */
            padding: 10px; /* 增加內邊距 */
            flex: 2; /* 設置 flex 屬性 */
            transition: background-color 0.3s ease; /* 添加過渡效果 */
        }

        .hotel-pricing {
            border: 1px solid gray;
            border-left: none; /* 移除左邊框 */
            text-align: right;
            background-color: #fff; /* 初始背景為白色 */
            padding: 10px; /* 增加內邊距 */
            flex: 1; /* 設置 flex 屬性 */
            transition: background-color 0.3s ease; /* 添加過渡效果 */
        }

        .hotel-info {
            display: flex; /* 使用 flex 布局 */
            width: 100%;
        }
    </style>

}


