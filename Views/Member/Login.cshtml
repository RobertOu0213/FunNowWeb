@{
    // ViewData["Title"] = "登入";
    Layout = "_Layout_login";
}

<meta charset="utf-8" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script src="https://kit.fontawesome.com/9bbb5484f7.js" crossorigin="anonymous"></script>

<body>
   

    <!--表單欄-->
    <div class="container" style="margin-top:50px">
        <div class="row justify-content-center align-items-center">
            <div class="col-lg-5 " style="min-width: 350px; max-width: 500px;">
                <div class="card border-0 shadow rounded-3 my-5 ">
                    <div class="card-body p-4 p-sm-5 " style="white-space: nowrap;">
                        <h3 class="sc-fzqyvX kJWwZs kite-js-Typography ">FunNow咖登入</h3>
                        <p>為了保障你的個資安全，請先登入才能查看個人資訊</p>
                        <hr style="border-top: 3px solid #0D6EFD; ">
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="EmailInput" class="form-label" style="font-size:15px">電子信箱</label>
                                <input type="email" class="form-control" id="EmailInput1" name="EmailInput" placeholder="電子信箱" onchange="queryEmail()">
                                <p id="resultYes" style="display:none" class="resultY form-text text-success">歡迎回來！趕緊輸入密碼來登入吧！</p>
                                <p id="resultNo" style="display:none" class="resultN form-text text-danger">Oops！這個Email沒有註冊過欸，請點選「我是新朋友」加入我們!</p>
                            </div>
                            <div id="result"></div>
                            <p></p>
                            <div class="mb-3">
                                <label for="PasswordInput" class="form-label" style="font-size:15px">密碼</label>
                                <input type="password" class="form-control" id="PasswordInput1" name="PasswordInput" placeholder="密碼">
                            </div>
                            <div class="mb-3">
                                <div class="row">
                                    <label for="VerifyInput" class="form-label" style="font-size:15px">驗證碼</label>

                                    <input type="text" class="form-control w-50 h-25 col ms-2 mt-2 align-middle" id="VerifyInput" placeholder="驗證碼">
                                    <div class="col">
                                        <img src="C:\Users\User\Desktop\Ruby\期末專題\期末專題0519\funnow\funnow\image\verify.png" style="width:100px" />
                                        <button class="btn" type="submit">重新產生</button>
                                    </div>
                                </div>

                            </div>

                            <div class="d-grid">
                                <button class="btn btn-primary btn-login text-uppercase fw-bold" type="button" id="loginBtn">登入</button>
                            </div>
                            <p></p>
                            <p id="error" class="alert alert-danger" style="display:none;">登入失敗，請重新確認電子信箱與密碼</p>
                            <div class="row">
                                <div>
                                    <a class="col ff1" asp-controller="Member" asp-action="Register">我是新朋友</a>
                                    <a class="col" style="font-size:14px"><i class="fa-solid fa-lock" style="color: #0d6efd;"></i> 忘記密碼？別慌，點此找幫手！</a>
                                </div>
                            </div>
                            <p style="margin:40px"></p>

                            <span class="line"></span>
                            <span>或使用以下方式登入</span>
                            <span class="line"></span>
                            <p></p>
                            <div class="d-grid mb-2">
                                <button class="btn btn-outline-danger fw-bold py-2 btn-zoom" type="submit" a asp-controller="Member" asp-action="LoginByGoogle">
                                    <i class="fab fa-google me-2"></i> Google
                                </button>
                            </div>
                            <div class="row">
                                <div class="col d-grid">
                                    <button class="btn btn-outline-primary fw-bold py-2 btn-zoom" type="submit">
                                        <i class="fab fa-facebook-f me-2"></i> Facebook
                                    </button>
                                </div>
                                <div class="col d-grid">
                                    <button class=" btn btn-outline-success fw-bold py-2 btn-zoom" type="submit">
                                        <i class="fa-brands fa-line"></i> Line
                                    </button>
                                </div>
                            </div>

                            <p style="margin:30px"></p>
                            <p style="text-align: center; font-size:13px;">點擊登錄即代表我同意FunNow的<a class="col bb">服務條款</a>和<a class="col bb">隱私權政策</a>。</p>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>



@section Styles
{
    <style>
        body {
            background: #F9F9F9;
            /*background: linear-gradient(to right, #0062E6, #33AEFF);*/
        }

        .btn-login {
            font-size: 0.9rem;
            letter-spacing: 0.05rem;
            padding: 0.75rem 1rem;
            background-color: #5392F9;
            border: none;
        }

            .btn-login:hover {
                background-color: #87b3fb;
            }

        a {
            text-decoration: none;
        }

            a:hover {
                color: #87b3fb;
                text-decoration: underline;
            }

        .btn-google {
            color: white !important;
            background-color: #ea4335;
        }

        .btn-facebook {
            color: white !important;
            background-color: #3b5998;
        }

        .btn-zoom {
            transition: transform 0.3s ease; /* 添加过渡效果 */
        }

            .btn-zoom:hover {
                transform: scale(1.02); /* 鼠标悬停时放大 1.1 倍 */
            }

        h3 {
            font-weight: 800;
        }

        .ff1 {
            font-size: 14px;
            margin: 0 70px 0 0;
            padding-left:0;
        }

        .line {
            display: inline-block;
            width: 120px;
            border-top: 1px solid #cccccc;
            vertical-align: 5px;
        }
        .bb
        {
           padding:0px;
        }


    </style>
}


@section Scripts
{

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        const emailInput = document.getElementById("EmailInput1");
        const passwordInput = document.getElementById("PasswordInput1");
        const errorElement = document.getElementById("error");
        const loginBtn = document.getElementById("loginBtn");

        //即時比對是否有該帳號存在
        async function queryEmail() {
            var email = emailInput.value;

            try {
                const response = await fetch("https://localhost:7103/api/Members/query", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: email })
                });

                const data = await response.json();
                var resultElementY = document.getElementById("resultYes");
                var resultElementN = document.getElementById("resultNo");

                resultElementY.style.display = "none";
                resultElementN.style.display = "none";

                if (data.message === "YES") {
                    resultElementY.style.display = "block";
                    emailInput.classList.remove("border", "border-danger");
                } else {
                    resultElementN.style.display = "block";
                    emailInput.classList.add("border", "border-danger");
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }


       

        //按下登入按鈕時，串接包含JWT驗證的Login API
        loginBtn.addEventListener("click", async function (event) {
            event.preventDefault();

            const email = emailInput.value;
            const password = passwordInput.value;

            try {
                const response = await fetch("https://localhost:7103/api/Login",
                    {
                        method: "POST",
                        headers:
                        {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ email, password })
                    });

                //如果成功串接API
                if (response.ok) 
                {
                    //拿到API回傳的資訊
                    const data = await response.json();

                    // 清除先前的LocalStorage，避免爆錯
                    clearLocalStorage();

                    // 把拿到資訊儲存在localStorage裡面
                    sessionStorage.setItem("JWToken", data.token);
                    sessionStorage.setItem("MemberID", data.memberInfo.memberId);
                    sessionStorage.setItem("MemberFisrtName", data.memberInfo.firstName);
                    sessionStorage.setItem("MemberLastName", data.memberInfo.lastName);
                    sessionStorage.setItem("MemberEmail", data.memberInfo.email);
                    sessionStorage.setItem("MemberPhone", data.memberInfo.phone);
                    sessionStorage.setItem("MemberBirthday", data.memberInfo.birthday);
                    sessionStorage.setItem("MemberRoleID", data.memberInfo.roleId);

                    console.log("攔截器啟動");
                    // 設置請求攔截器以自動添加Authorization標頭
                    // 重新定義全域的 window.fetch 函式, 在發送每個請求時自動將 JWT Token 添加到請求標頭中。
                    
                    // 保存了原始的 fetch 函式
                    const originalFetch = window.fetch;

                    // 重新定義 window.fetch
                    // ...args 是一個 rest 參數語法,它可以將所有傳入的參數收集到一個陣列中
                    window.fetch = async (...args) => {
                        //這一行是使用解構賦值來從 args 陣列中取出第一個元素(即資源 URL)並指派給 resource 變數,
                        //同時將第二個元素(即請求配置物件)指派給 config 變數。
                        const [resource, config] = args;

                        const token = sessionStorage.getItem('JWToken');

                        if (!token) 
                        {
                            console.log("沒有拿到token");
                            console.log(resource);
                            console.log(config);
                            return originalFetch(resource, config);
                        }
                        
                         // 如果有 Token,構建一個新的請求配置物件
                            const newConfig = {
                                ...config,
                                headers: {
                                    ...config.headers,
                                    Authorization: `Bearer ${token}`
                                }
                            };

                        console.log("拿到token");
                        console.log(resource);
                        console.log(newConfig);
                        console.log("攔截器結束");
                        //如果原始配置物件 config 不存在,它會直接創建一個新物件,只包含 headers 屬性,其值為 { Authorization: Bearer ${token} }。
                        return originalFetch(resource, newConfig);
                    };

                    //通過攔截器後重新導向首頁
                   window.location.href = "/Home/Index";
                }
                
                else 
                {
                    passwordInput.value = ""; // 清空密碼
                    alert("登入失敗，請重新確認電子信箱和密碼");
                    //errorElement.style.display = "block";
                }
            } 
            catch (error) 
            {
                console.error('錯誤為:',error);
            }
        });


        function clearLocalStorage() 
        {
            sessionStorage.removeItem("JWToken");
            sessionStorage.removeItem("MemberID");
            sessionStorage.removeItem("MemberFisrtName");
            sessionStorage.removeItem("MemberLastName");
            sessionStorage.removeItem("MemberEmail");
            sessionStorage.removeItem("MemberPhone");
            sessionStorage.removeItem("MemberBirthday");
            sessionStorage.removeItem("MemberRole");
        }
    </script>


    
    <script>
        //Google驗證失敗時跳出的錯誤訊息
        document.addEventListener("DOMContentLoaded", function () {
            var errorMessage = '@TempData["ErrorMessage"]';
            if (errorMessage) {
                alert(errorMessage);
            }
        });

   

        //改成用串接API的方式，就不用這個了~
        // //登入資料的錯誤訊息
        // $(document).ready(function () {
        //     $('#loginBtn').click(function (event) {
        //         event.preventDefault();
        //         var email = $('#EmailInput1').val();
        //         var password = $('#PasswordInput1').val();

        //         $.ajax({
        //             type: 'POST',
        //             url: '@Url.Action("Login", "Member")',
        //             data: { EmailInput: email, PasswordInput: password },
        //             success: function (response) 
        //             {
        //                 if (response.success) 
        //                 {
        //                     window.location.href = response.redirectUrl;
        //                 } else 
        //                 {
        //                     alert('登入失敗，請檢查您的電子信箱和密碼。');
        //                 }
        //             },
        //             error: function () {
        //                 alert('發生錯誤，請稍後再試。');
        //             }
        //         });
        //     });
        // });

    </script>
   
}