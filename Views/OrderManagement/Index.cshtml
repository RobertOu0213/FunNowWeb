@{
    Layout = "_Layout_OrderManagement";
}
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>範例頁面</title>
    <link rel="stylesheet" href="/Ting/css/OrderManagement.css">
</head>
<body>
    <br />
    <br />
    <br />
    <br />
    <div class="container">
        <div class="content-wrapper">
            <div class="sidebar">
                <ul>
                    <li>
                        <a href="#" alt="管理訂單">
                            <div class="icon"><i class="fa-solid fa-calendar-days"></i></div>
                            <div class="text"><span>管理訂單</span></div>
                        </a>
                    </li>
                    <li>
                        <a href="#" alt="所有訂單">
                            <div class="icon"><i class="fa-solid fa-briefcase"></i></div>
                            <div class="text"><span>所有訂單</span></div>
                        </a>
                    </li>
                    <li>
                        <a href="#" alt="住宿">
                            <div class="icon"><i class="fa-solid fa-building"></i></div>
                            <div class="text"><span>住宿</span></div>
                        </a>
                    </li>
                    <li>
                        <a href="#" alt="機票">
                            <div class="icon"><i class="fa-solid fa-plane"></i></div>
                            <div class="text"><span>機票</span></div>
                        </a>
                    </li>
                    <li>
                        <a href="#" alt="活動體驗">
                            <div class="icon"><i class="fa-solid fa-person-skiing-nordic"></i></div>
                            <div class="text"><span>活動體驗</span></div>
                        </a>
                    </li>
                    <li>
                        <a href="#" alt="住宿訊息">
                            <div class="icon"><i class="fa-solid fa-comment-dots"></i></div>
                            <div class="text"><span>住宿訊息</span></div>
                        </a>
                    </li>
                    <li>
                        <a href="#" alt="住宿評鑑">
                            <div class="icon"><i class="fa-solid fa-star"></i></div>
                            <div class="text"><span>住宿評鑑</span></div>
                        </a>
                    </li>
                    <li>
                        <a href="#" alt="AgodaVIP">
                            <div class="icon"><i class="fa-solid fa-crown"></i></div>
                            <div class="text"><span>Agoda客服</span></div>
                        </a>
                    </li>
                    <li>
                        <a href="#" alt="A金回饋">
                            <div class="icon"><i class="fa-solid fa-money-check-dollar"></i></div>
                            <div class="text"><span>A金回饋</span></div>
                        </a>
                    </li>
                    <li>
                        <a href="#" alt="現金回饋">
                            <div class="icon"><i class="fa-solid fa-sack-dollar"></i></div>
                            <div class="text"><span>現金回饋</span></div>
                        </a>
                    </li>
                    <li>
                        <a href="#" alt="PointsMAX">
                            <div class="icon"><i class="fa-solid fa-piggy-bank"></i></div>
                            <div class="text"><span>PointsMAX</span></div>
                        </a>
                    </li>
                    <li>
                        <a href="#" alt="個人資料">
                            <div class="icon"><i class="fa-solid fa-user"></i></div>
                            <div class="text"><span>個人資料</span></div>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="content">
                <div class="content-header">
                    <h2>所有訂單</h2>
                    <div class="actions">
                        <input type="text" placeholder="以訂單編號搜尋">
                    </div>
                </div>
                <div class="tabs">
                    <div class="tab__link active" id="ongoingTab">未來式</div>
                    <div class="tab__link" id="completedTab">過去式</div>
                    <div class="tab__link" id="cancelledTab">已取消</div>
                </div>
                <div class="main-content" id="tabContent">
                </div>
                <div>
                    <br />
                    <br />
                    <br />
                    <br />
                    <br />
                    <br />
                    <br />
                    <br />
                    <br />
                    <br />
                </div>
            </div>
        </div>
    </div>
    <script src="https://kit.fontawesome.com/091893cea4.js" crossorigin="anonymous"></script>
    <script defer>
        document.addEventListener('DOMContentLoaded', () => {
            const ongoingTab = document.getElementById('ongoingTab');
            const completedTab = document.getElementById('completedTab');
            const cancelledTab = document.getElementById('cancelledTab');
            const tabContent = document.getElementById('tabContent');

            function setActiveTab(selectedTab) {
                document.querySelectorAll('.tab__link').forEach(tab => {
                    tab.classList.remove('active');
                });
                selectedTab.classList.add('active');
            }

            function formatOrderData(data) {
                let htmlContent = '';
                if (data && data.$values && data.$values.length > 0) {
                    data.$values.forEach(order => {
                        // 获取第一个订单详情的第一个酒店图像路径
                        let hotelImage = '';
                        if (order.orderDetails.$values.length > 0 && order.orderDetails.$values[0].hotelImages.$values.length > 0) {
                            hotelImage = order.orderDetails.$values[0].hotelImages.$values[0];
                        }

                        // Determine if the stay is completed or not
                        const currentDate = new Date();
                        const checkOutDate = new Date(order.orderDetails.$values[0].checkOutDate);
                        const isStayCompleted = currentDate > checkOutDate;

                        // Set button text and class based on the stay status
                        const buttonText = isStayCompleted ? '再預訂' : '需要取消';
                        const buttonClass = isStayCompleted ? 'rebook-button' : 'cancel-button';

                        htmlContent += `
                        <div class="order-card">
                            <div class="order-card-header">
                                <a href="#" class="order-number">訂單編號: ${order.orderId}</a>
                                <div class="order-date">預訂日期: ${new Date(order.createdAt).toLocaleDateString()}</div>
                            </div>
                            <div class="order-card-body">
                                <div class="hotel-image">
                                    <img src="${hotelImage}" alt="Hotel Image">
                                </div>
                                <div class="order-info">
                                    <h3>${order.orderDetails.$values[0].hotelName}</h3>
                                    <p class="date-range">${new Date(order.orderDetails.$values[0].checkInDate).toLocaleDateString()} - ${new Date(order.orderDetails.$values[0].checkOutDate).toLocaleDateString()}</p>
                                </div>
                                <div class="order-info">
                                    <p class="guest-info">${order.guestLastName} ${order.guestFirstName}</p>
                                    <p class="guest-info">${order.guestEmail}</p>
                                </div>
                                <div class="price">NT$${order.totalPrice}</div>
                            </div>
                            <div class="order-card-footer">
                                <div class="order-status">已確認</div>
                                <div class="${buttonClass}"><a href="#">${buttonText}</a></div>
                            </div>
                        </div>
                    `;
                    });
                } else {
                    htmlContent = '<p>暫無訂單數據可顯示。</p>';
                }
                return htmlContent;
            }



            function loadTabContent(url) {
                fetch(url)
                    .then(response => {
                        if (response.status === 200) {
                            return response.json();
                        } else {
                            throw new Error('Failed to load data, status code: ' + response.status);
                        }
                    })
                    .then(data => {
                        if (data.$values && data.$values.length > 0) {
                            tabContent.innerHTML = formatOrderData(data);
                        } else {
                            tabContent.innerHTML = '<p>暫無訂單數據可顯示。</p>';
                        }
                    })
                    .catch(error => {
                        console.error('資料載入失敗:', error);
                        tabContent.innerHTML = `
                                        <h3>目前沒有任何即將到來的預訂</h3>
                                        <p>開始計劃下一次的旅行吧！</p>
                                        <div class="buttons">
                                            <a href="#">找住宿？</a>
                                            <a href="#">找機票</a>
                                            <a href="#">找活動體驗</a>
                                        </div>
                                    `;
                    });
            }

            ongoingTab.addEventListener('click', () => {
                setActiveTab(ongoingTab);
                loadTabContent('https://localhost:7103/api/Orders/ByMemberAndStatus/2/1');
            });

            completedTab.addEventListener('click', () => {
                setActiveTab(completedTab);
                loadTabContent('https://localhost:7103/api/Orders/ByMemberAndStatus/2/2');
            });

            cancelledTab.addEventListener('click', () => {
                setActiveTab(cancelledTab);
                loadTabContent('https://localhost:7103/api/Orders/ByMemberAndStatus/2/3');
            });

            setActiveTab(ongoingTab);
            loadTabContent('https://localhost:7103/api/Orders/ByMemberAndStatus/2/1');
        });
    </script>
</body>
</html>
