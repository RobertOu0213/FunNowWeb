@using System.Text.Json

@{
    var memberID = Context.Session.GetString("MemberID");
    var googleMemberId = Context.Session.GetString("GoogleMemberID");
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - FUNNOW</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="icon" href="~/image/ming_img/funnowlogo3.png" type="image/png">
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />

    <style>
            .booking-area {
                background-color: #20274d;
                padding: 20px;
            }
            
            .form-control, .btn {
                margin-bottom: 10px;
            }

            .d-flex.align-items-center label {
                color: white;
                margin-bottom: 0;
                margin-right: 3px; /* 減少標籤與輸入框之間的間距 */
                white-space: nowrap; /* 確保標籤不換行 */
            }

            .d-flex.align-items-center input {
                flex-grow: 1; /* 確保輸入框佔據剩餘空間 */
            }

            .navbar {
                height: 70px;
                padding: 0 15px;
                box-shadow: rgba(0, 0, 0, 0.3) 0px 0px 8px 2px;
            }

            .navbar-container {
                max-width: 1200px;
                margin: 0 auto;
            }

            .navbar-logo {
                height: 40px;
                border-radius: 12px;
            }

            .nav-btn {
                margin-right: 10px;
                padding: 5px 10px;
                border: 1px solid #fe4a55 !important;
                color: #fe4a55 !important;
                margin-top: 8px;
                font-size: 14px !important;
                text-decoration: none; /* 移除底線 */
            }

                .nav-btn:hover {
                    background-color: #fe4a55;
                    color: white !important;
                    text-decoration: none; /* 確保懸浮時不會出現底線 */
                }

            .nav-btn-primary {
                background-color: #00023c !important;
                color: white !important;
                margin-top: 8px;
                border-color: #00023c !important;
                text-decoration: none; /* 移除底線 */
            }

                .nav-btn-primary:hover {
                    background-color: white !important;
                    color: #00023c !important;
                    border-color: #00023c !important;
                    text-decoration: none; /* 確保懸浮時不會出現底線 */
                }

            .member-nav {
                display: flex;
                align-items: center;
            }

            .member-nav-item {
                margin-right: 10px; /* 為每個元素添加右邊距 */
            }

                .member-nav-item:last-child {
                    margin-right: 0; /* 移除最後一個元素的右邊距 */
                }

            .post-link {
                color: #fe4a55;
                border: 1px solid #fe4a55;
                border-radius: 4px;
                padding: 5px 10px;
                font-size: 14px;
                white-space: nowrap; /* 防止文字換行 */
                text-decoration: none; /* 移除底線 */
            }

                .post-link:hover {
                    background-color: #fe4a55;
                    color: white;
                    text-decoration: none; /* 確保懸浮時不會出現底線 */
                }

            .nav-link {
                display: flex;
                align-items: center;
                white-space: nowrap; /* 防止文字換行 */
                text-decoration: none; /* 移除底線 */
            }

            #NavMemberName {
                overflow: hidden;
                text-overflow: ellipsis; /* 如果文字太長，使用省略號 */
                max-width: 150px; /* 設置最大寬度，根據需要調整 */
                color: #00013d;
            }

            @@media (max-width: 991px) {
                #MemberContent, #guestContent {
                    flex-direction: column;
                    align-items: flex-start;
                }

            }
        </style>
    @await RenderSectionAsync("Styles", required: false)
    </head>
<body>
    <header class="header_area">
        <div class="container-fluid" style="padding: 0;">
            <nav class="navbar navbar-expand-lg">
                <div class="navbar-container d-flex justify-content-between align-items-center w-100">
                    <!-- Logo -->
                    <a class="navbar-brand logo_h" href="/home/index">
                        <img src="~/image/ming_img/newnewLogo.png" alt="Logo" class="navbar-logo">
                    </a>

                    <!-- Navbar content -->
                    <div id="MemberContent" class="d-none align-items-center member-nav">
                        <a href="/HostManage/Home" class="nav-item nav-link post-link member-nav-item" style="margin-right:0px"><i class="fa-solid fa-house" style="margin-right:3px"></i>刊登家中空房</a>
                        <a href="/Cart/cartItems" class="nav-item nav-link member-nav-item cart-icon" style="margin-right:0px; padding-left:30px">
                            <i class="fa-solid fa-cart-shopping"></i>
                        </a>
                        <div class="nav-item dropdown member-nav-item">
                            <a href="#" class="nav-link dropdown-toggle no-caret d-flex align-items-center" data-bs-toggle="dropdown">
                                <img id="NNavProfileImg" class="NNavProfileImg mr-2" src="https://cdn2.ettoday.net/images/1457/d1457772.jpg" alt="Profile">
                                <span id="NavMemberName"></span>
                            </a>
                            <div class="dropdown-menu">
                                <a class="dropdown-item" href="/OrderManagement/Index">我的訂單</a>
                                <a class="dropdown-item" href="/OrderManagement/HotelMessenge">我的訊息</a>
                                <a class="dropdown-item" href="/HotelsFavorites/HotelsFavoritesList">我的最愛</a>
                                <a class="dropdown-item" href="/Comment/Angular_membercomment">我的評論</a>
                                <a class="dropdown-item" asp-controller="MemberInformationn" asp-action="Memberinformationn">個人資料管理</a>
                            </div>
                        </div>
                        <button class="btn NNavLogoutButton member-nav-item" id="NNavLogoutButton">我要登出<i class="fa-solid fa-right-from-bracket" style="margin-left:5px"></i></button>
                    </div>

                    <!-- Guest content -->
                    <div id="guestContent" class="d-none align-items-center">
                        <a href="@Url.Action("Login", "Member")" class="btn nav-btn"><i class="fa-solid fa-door-open" style="margin-right:3px"></i>我要登入</a>
                        <a href="@Url.Action("Register", "Member")" class="btn nav-btn"><i class="fa-solid fa-address-card" style="margin-right:3px"></i>我是新朋友</a>
                        <a href="@Url.Action("Index", "Home")" class="btn nav-btn nav-btn-primary">先逛逛首頁<i class="fa-solid fa-car-side" style="margin-left:5px"></i></a>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <div>
        @RenderBody()
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/ming_js/site.js" asp-append-version="true"></script>
    <script src="https://kit.fontawesome.com/4f1ac4ae93.js" crossorigin="anonymous"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var NavGoogleMemberId = '@googleMemberId';
            var NavMemberID = '@memberID';
            let NavLoginmemberID;

            if (NavMemberID) {
                NavLoginmemberID = NavMemberID;
            } else {
                NavLoginmemberID = NavGoogleMemberId;
            }

            const memberContent = document.getElementById("MemberContent");
            const guestContent = document.getElementById("guestContent");

            if (!NavLoginmemberID) {
                // 未登入
                if (guestContent) {
                    guestContent.classList.remove('d-none');
                    guestContent.classList.add('d-flex');
                }
            } else {
                // 已登入
                if (memberContent) {
                    memberContent.classList.remove('d-none');
                    memberContent.classList.add('d-flex');
                    fetchMemberData(NavLoginmemberID);
                }
            }
        });

        async function fetchMemberData(NavLoginmemberID) {
            try {
                const NavResponse = await fetch(`https://localhost:7103/api/Members/searchByID?ID=${NavLoginmemberID}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                });
                if (NavResponse.ok) {
                    const NavData = await NavResponse.json();
                    let NavLastName = NavData.lastName || "";

                    const navMemberName = document.getElementById("NavMemberName");
                    if (navMemberName) {
                        navMemberName.innerText = `${NavData.firstName}\xa0${NavLastName}`;
                    }

                    if (NavData.image) {
                        const NNavProfileImg = document.getElementById("NNavProfileImg");
                        if (NNavProfileImg) NNavProfileImg.src = NavData.image;
                    }
                } else {
                    const errorText = await NavResponse.text();
                    console.error('查詢失敗:', errorText);
                    alert('查詢失敗，請稍後再試');
                }
            } catch (error) {
                console.error('發生錯誤:', error);
                alert(`發生錯誤，請稍後再試。錯誤信息: ${error.message}`);
            }
        }

        document.getElementById("NNavLogoutButton").addEventListener("click", function () {
            window.location.href = "@Url.Action("Logout", "Member")";
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>