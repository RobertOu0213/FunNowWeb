
@{
    ViewData["Title"] = "paymentPage";
    var member = ViewBag.Member as PrjFunNowWeb.Models.Member;
    @model List<PrjFunNowWeb.Models.ViewModel.CReservationSummaryViewModel>
    Layout = "_Layout_Order";
}

<main>
    <section class="left-section">
        <form action='@Url.Content("~/Payment/thankyou")' method="post">
            <input type="hidden" name="TotalPrice" value="@Model.Sum(m => m.RoomPrice * m.NumberOfNights)" />
            @foreach(var item in Model)
            {
                <input type="hidden" name="OrderDetailsID" value="@item.OrderDetailID" />
            }
            <div class="contact-info p-3">
                <div class="contact-info-static mb-2">
                    <div class="" style="font-size:12px; color:grey;">針對所有預定</div>
                    <div class="fw-bold">聯絡資訊</div>
                    <div class="pt-1 pb-1 text-sm">您的確認信將寄至此</div>
                </div>
                <div class="contact-info-label">
                    <div class="d-flex">
                        <div class="w-100 m-1">

                            <label for="firstname">名字*</label>
                            <input type="text" id="firstname" name="firstname" value="@member.FirstName" class="form-control" disabled>

                        </div>
                        <div class="w-100 m-1">

                            <label for="lastname">姓氏*</label>
                            <input type="text" id="lastname" name="lastname" value="@member.LastName" class="form-control" disabled>
                        </div>
                    </div>
                    <div class="d-flex">
                        <div class="w-100 m-1">

                            <label for="email">電子郵件地址*</label>
                            <input type="email" id="email" name="email" value="@member.Email" class="form-control" disabled>
 
                        </div>
                        <div class="w-100 m-1">

                            <label for="phone">電話號碼*</label>
                            <input type="text" id="phone" name="phone" value="@member.Phone" class="form-control" disabled>

                        </div>
                    </div>
                </div>
            </div>
            <div class="user-info">
                <div>住客資料</div>
                <hr>
                <div class="contact-info-label">
                    <div class="d-flex">
                        <div class="w-100 m-1">
                            <label for="firstname">名字</label>
                            <input type="text" id="firstname" name="GuestFirstName"  class="form-control">
                        </div>
                        <div class="w-100 m-1">
                            <label for="lastname">姓氏</label>
                            <input type="text" id="lastname" name="GuestLastName"  class="form-control">
                        </div>
                    </div>
                    <div class="d-flex">
                        <div class="w-100 m-1">
                            <label for="email">電子郵件地址</label>
                            <input type="email" id="email" name="GuestEmail"  class="form-control w-50">
                        </div>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-end mt-3">
                <button type="submit" class="btn btn-primary col-4 rounded-pill fw-bold">前往付款頁面</button>
            </div>
        </form>
    </section>





    <section class="right-section">
        <div class="reservation-container mb-3">
            <div class="reservation-container-title">預訂摘要</div>
            @foreach (var item in Model)
            {
                <div class="reservation-container-info hotelContainer" data-hotel-id="@item.HotelID">
                    <div class="mb-3">
                        <i class="fa-solid fa-city fa-xs"></i>
                        <span>住宿</span>
                        <span class="text-neutral-400 text-xs">@item.CityName</span>
                    </div>
                    <div class="d-flex mb-4">
                        <div><img class="reservation-container-info-img" src="@item.RoomImage" alt="..." /></div>
                        <div class="ms-2">
                            <div class="fw-bolder">@item.HotelName</div>
                            <div>
                                @for (int i = 0; i < item.LevelStar; i++)
                                {
                                    <i class="fa-solid fa-star fa-xs"></i>
                                }
                            </div>
                            <div class="d-flex">
                                <div class="reservation-container-info-score averageScore"></div>
                                <div class="d-flex flex-column mt-2">
                                    <span class="text-xs ratingText"></span>
                                    <span class="commentsCount">得分自 @item.AllCommentsCount 篇評鑑</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <i class="fa-solid fa-calendar-days me-2"></i>
                        <span>@item.CheckInDate.ToString("yyyy年MM月dd日")</span>
                        <span>-</span>
                        <span>@item.CheckOutDate.ToString("yyyy年MM月dd日")</span>
                        <span>|</span>
                        <span>@item.NumberOfNights 晚</span>
                    </div>
                    <div>
                        <i class="fa-solid fa-bed me-1"></i>
                        <span>1 x @item.RoomType</span>
                    </div>
                    <div class="mb-2">
                        <span class="peopleLimit">入住人數限制：</span>
                        <span>@item.MaximumOccupancy 位大人</span>
                    </div>
                    <div class="mb-4">
                        <span>旅客：</span>
                        <span>@item.MaximumOccupancy 位大人</span>
                    </div>
                </div>
            }
        </div>
        <div class="payment-detail">
            <div class="fs-5">收費明細</div>
            <div class="d-flex justify-content-between">
                <div>總價</div>
                <div>NT @Model.Sum(m => m.RoomPrice * m.NumberOfNights)</div>
            </div>
            <div class="taxText">
                含稅與附加費用
            </div>
        </div>
    </section>

</main>


@section Styles {
    <link rel="stylesheet" href="~/ou/css/paymentPage.css" />
}
@section Scripts {
    <script>

        $(document).ready(function () {
            async function fetchRatings() {
                const elements = $('.hotelContainer');
                const promises = elements.map(async function () {
                    const element = $(this);
                    const hotelId = element.data('hotel-id');
                    try {
                        const response = await fetch(`https://localhost:7103/api/Comment/AverageRatingText/${hotelId}`);
                        if (!response.ok) {
                            throw new Error(response.statusText);
                        }
                        const data = await response.json();
                        element.find('.averageScore').text(Math.round(data.averageScore));
                        element.find('.ratingText').text(data.ratingText);
                    } catch (error) {
                        console.error(error);
                    }
                });

                await Promise.all(promises);
            }

            fetchRatings();
        });


    </script>
}